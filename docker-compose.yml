version: "3.9"

x-common: &trainer
  platform: linux/amd64
  build: .
  image: dino-rl:latest
  working_dir: /app
  environment:
    - DISPLAY=:99
    - CHROME_URL=https://chromedino.com
  volumes:
    - ./:/app

services:
  # Quick smoke test (recommended to try first)
  test:
    <<: *trainer
    command: >
      python - <<'PY'
      from envs.chrome_dino_env import ChromeDinoEnv
      env = ChromeDinoEnv(input_backend="xdotool", auto_calibrate=True, monitor_index=0,
                          termination_method="template")
      obs,_ = env.reset()
      for _ in range(5):
          obs,r,d,tr,info = env.step(0)
          if d: break
      env.close()
      print("smoke ok")
      PY
    profiles: ["test"]

  # PPO baseline
  ppo_baseline:
    <<: *trainer
    command: >
      python -m scripts.train_ppo
      --config configs/ppo_baseline.yaml
      --seeds 0 1 2
      --total_timesteps 50000
      --device cpu
      --set env.input_backend=xdotool env.auto_calibrate=true env.termination_method=template
    profiles: ["ppo","all"]

  # DQN baseline
  dqn_baseline:
    <<: *trainer
    command: >
      python -m scripts.train_dqn
      --config configs/dqn_baseline.yaml
      --seeds 0 1 2
      --total_timesteps 50000
      --set env.input_backend=xdotool env.termination_method=template
    profiles: ["dqn","all"]
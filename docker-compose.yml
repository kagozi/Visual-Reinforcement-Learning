x-common: &trainer
  build: .
  image: dino-rl:latest
  working_dir: /app
  environment:
    - DISPLAY=:99
    - CHROME_URL=http://127.0.0.1:8080     # served by nginx in the same container
  volumes:
    - ./:/app
  # (Optional) let you view the game in your host browser at http://localhost:18080
  ports:
    - "18080:8080"

services:
  test:
    <<: *trainer
    command: >
      python - <<'PY'
      from envs.chrome_dino_env import ChromeDinoEnv
      env = ChromeDinoEnv(input_backend="xdotool", auto_calibrate=True, termination_method="template",
                          template_thr=0.62)
      obs,_ = env.reset()
      print("obs stats:", obs.shape, float(obs.mean()), float(obs.std()))
      for _ in range(20):
          obs,r,d,tr,_ = env.step(1)
          if d: break
      env.close()
      print("smoke ok")
      PY
    profiles: ["test"]

  ppo_baseline:
    <<: *trainer
    command: >
      python -m scripts.train_ppo
      --config configs/ppo_baseline.yaml
      --seeds 0 1 2
      --total_timesteps 50000
      --device cpu
      --set experiment.debug_dump=true env.input_backend=xdotool env.auto_calibrate=true env.termination_method=template env.template_thr=0.62
    profiles: ["ppo","all"]

  dqn_baseline:
    <<: *trainer
    command: >
      python -m scripts.train_dqn
      --config configs/dqn_baseline.yaml
      --seeds 0 1 2
      --total_timesteps 50000
      --set experiment.debug_dump=true env.input_backend=xdotool env.auto_calibrate=true env.termination_method=template env.template_thr=0.62
    profiles: ["dqn","all"]
